<!--
  Copyright (C) 2018-present evan GmbH.

  This program is free software: you can redistribute it and/or modify it
  under the terms of the GNU Affero General Public License, version 3,
  as published by the Free Software Foundation.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  See the GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program. If not, see http://www.gnu.org/licenses/ or
  write to the Free Software Foundation, Inc., 51 Franklin Street,
  Fifth Floor, Boston, MA, 02110-1301 USA, or download the license from
  the following URL: https://evan.network/license/

  You can be released from the requirements of the GNU Affero General Public
  License by purchasing a commercial license.
  Buying such a license is mandatory as soon as you use this software or parts
  of it on other blockchains than evan.network.

  For more information, please contact evan GmbH at this address:
  https://evan.network/license/
-->

<ng-template #claimDisplay let-topics="topics">
  <ng-container *ngFor="let topic of topics; let i = index">
    <div >
      <h3 class="content-header m-b-0 m-t-0">
        {{ '_claims.topic-title' | translate }}: {{ topic }}
      </h3>

      <button ion-button outline round icon-left
        [class.top-right]="core.utils.isMD"
        [disabled]="savingTopicDetail"
        *ngIf="topicDetails[i].owner === activeAccount"
        (click)="topicDetails[i].showDescription = !topicDetails[i].showDescription; ref.detectChanges()">
        <ion-icon name="create" *ngIf="!savingTopicDetail"></ion-icon>
        <ion-spinner *ngIf="savingTopicDetail"></ion-spinner>
        {{ '_claims.adjust-description' | translate }}
      </button>
    </div>

    <form class="evan-content description-container" margin-top #descForm="ngForm"
      *ngIf="topicDetails[i].owner === activeAccount && topicDetails[i].showDescription"
      [@opacityTransition]>
      <h3 class="content-header m-b-0 m-t-0">
        {{ '_claims.claim-description' | translate }}: {{ topic }}
      </h3>

      <ion-row>
        <ion-col col-md-6 col-12 *ngIf="showTopicSelect">
          <ion-item>
            <ion-label stacked>
             {{ '_claims.descName.title' | translate }}*
            </ion-label>
            <ion-input name="descName" required autofocus
              [(ngModel)]="topicDetails[i].description.i18n.name.en"
              [placeholder]="'_claims.descName.desc' | translate"
              (ionChange)="ref.detectChanges()"
              (focusout)="ref.detectChanges()">
            </ion-input>
          </ion-item>
          <ion-chip class="error-hint" *ngIf="showError(descForm, 'descName')" color="danger">
            <ion-label>{{ '_claims.descName.error' | translate }}</ion-label>
          </ion-chip>
        </ion-col>
        <ion-col col-md-6 col-12>
          <ion-label class="standalone">
           {{ '_claims.select-desc-img.title' | translate }}*
          </ion-label>

          <div text-center class="img-selector">
            <svg *ngIf="!topicDetails[i].description.imgSquare" version="1.0" xmlns="http://www.w3.org/2000/svg"
              width="512.000000pt" height="512.000000pt" viewBox="0 0 512.000000 512.000000"
              preserveAspectRatio="xMidYMid meet">
                <g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)" stroke="none">
                <path d="M2510 4994 c-135 -140 -432 -395 -635 -547 -502 -375 -990 -618
                -1444 -719 l-104 -23 7 -107 c14 -233 92 -597 192 -894 311 -930 933 -1793
                1784 -2475 164 -131 188 -149 198 -149 20 0 283 183 420 293 594 475 1057
                1046 1388 1712 233 468 377 929 453 1450 12 77 21 147 21 156 0 11 -34 29
                -112 58 -335 126 -816 354 -1103 522 -374 219 -660 429 -906 667 -59 56 -108
                102 -111 102 -2 0 -24 -21 -48 -46z m143 -406 c392 -340 1056 -731 1682 -988
                72 -30 133 -56 137 -59 9 -7 -39 -250 -82 -421 -141 -556 -410 -1114 -770
                -1595 -149 -199 -270 -337 -474 -540 -200 -200 -320 -306 -491 -434 -144 -108
                -115 -109 -248 2 -422 354 -786 755 -1063 1172 -301 452 -517 931 -632 1405
                -33 135 -74 361 -67 368 2 3 69 26 147 52 466 156 946 432 1439 826 63 51 163
                135 223 188 59 53 109 96 112 96 2 0 41 -32 87 -72z"/>
                <path d="M2555 4460 c-11 -17 -256 -219 -395 -324 -411 -312 -848 -557 -1240
                -697 l-105 -37 2 -45 c2 -66 66 -317 127 -501 258 -773 756 -1489 1469 -2114
                l118 -104 37 28 c209 159 518 451 698 659 421 487 719 1003 908 1577 53 162
                126 451 129 509 l2 41 -110 47 c-609 263 -1145 578 -1582 930 -29 24 -54 37
                -58 31z"/>
              </g>
            </svg>
            <img
              *ngIf="topicDetails[i].description.imgSquare"
              [src]="_DomSanitizer.bypassSecurityTrustUrl(topicDetails[i].description.imgSquare)">

            <evan-file-select name="image" #imgFileSelect
              class="img-file-select"
              [(ngModel)]="topicDetails[i].image"
              [accept]="'image/x-png,image/gif,image/jpeg'"
              [buttonText]="'_claims.select-desc-img.select' | translate"
              [multiple]="false"
              (onChange)="descriptionImgChanged(topicDetails[i])">
            </evan-file-select>

            <div text-center>
              <button ion-button outline round margin-top icon-left
                (click)="imgFileSelect.selectFiles()">
                {{ '_claims.select-desc-img.select' | translate }}
              </button>
            </div>
          </div>
        </ion-col>
      </ion-row>

      <div text-right>
        <button ion-button outline round margin-top icon-left
          [disabled]="!topicDetails[i].description.i18n.name.en || savingTopicDetail"
          (click)="setDescription(topicDetails[i])">
          <ion-spinner *ngIf="savingTopicDetail"></ion-spinner>

          {{ '_claims.set-description' | translate }}
        </button>
      </div>
    </form>

    <evan-claim
      [topic]="topic"
      [address]="useAddressInput ? subject : subjectSelect[0]"
      [mode]="displayMode"
      [compute]="computedClaims">
    </evan-claim>
  </ng-container>
</ng-template>

<evan-loading *ngIf="loading"></evan-loading>
<ng-container *ngIf="!loading">
  <evan-identity-missing *ngIf="!identityExists"></evan-identity-missing>
  <ng-container *ngIf="identityExists">
    <ng-container *ngIf="showAddressSelect || showTopicSelect">
      <div class="evan-content evan-relative">
        <h3 class="content-header m-b-0 m-t-0">
          {{ '_claims.claim-analyse' | translate }}
        </h3>
        <p ion-text class="m-b-0 m-t-0" *ngIf="!showAddressSelect">
          {{ (addressbook[subject]?.alias || addressbook[subject]?.email) ? (addressbook[subject]?.alias || addressbook[subject]?.email) + ' (' + subject + ')' : subject }}
        </p>
        <form #selectForm="ngForm">
          <ion-row>
            <ion-col col-12 *ngIf="showTopicSelect">
              <div class="display-flex-justify">
                <ion-item>
                  <ion-label stacked>
                    {{ '_claims.topic.title' | translate }}*
                  </ion-label>
                  <ion-input name="topic" required autofocus
                    [(ngModel)]="topic"
                    [placeholder]="'_claims.topic.desc' | translate"
                    (ionChange)="ref.detectChanges()"
                    (keydown)="submitOnEnter($event)"
                    (focusout)="ref.detectChanges()">
                  </ion-input>
                </ion-item>
                <button ion-button icon-only round clear class="claim-topic-open"
                  (click)="claimTopicSelect.open($event)">
                  <ion-icon name="arrow-dropdown"></ion-icon>
                </button>
                <ion-select name="claimTopicSelect" class="evan-callout" interface="popover"
                  #claimTopicSelect
                  [(ngModel)]="topic"
                  [selectOptions]="{ cssClass: 'evan-callout evan-topic-prefill top' }"
                  (ionChange)="ref.detectChanges()">
                  <ion-option
                    *ngFor="let prefilledClaim of prefilledClaims"
                    [value]="prefilledClaim">
                    {{ prefilledClaim }}
                  </ion-option>
                </ion-select>
              </div>
              <ion-chip class="error-hint" *ngIf="showError(selectForm, 'topic')" color="danger">
                <ion-label>{{ '_claims.topic.error' | translate }}</ion-label>
              </ion-chip>
            </ion-col>
          </ion-row>
          <ion-row *ngIf="showAddressSelect">
            <ion-col col-12 col-md-6 class="checkbox-input">
              <div class="checkbox-input">
                <ion-checkbox name="useAddressBook" margin-right
                  [(ngModel)]="useAddressBook"
                  (click)="useAddressInput = false; useAddressBook = true; detectTimeout()"
                  (ionChange)="ref.detectChanges()"
                  (focusout)="ref.detectChanges()">
                </ion-checkbox>
                <contract-members name="subject" #subjectSelectComp
                  [(members)]="subjectSelect"
                  [disabled]="useAddressInput"
                  includeActiveAccount="true"
                  maxMembers="1"
                  (onChange)="ref.detectChanges()">
                  <h3 label>{{ '_claims.subject.title-addressbook' | translate }}*</h3>
                </contract-members>
              </div>
            </ion-col>
            <ion-col col-12 col-md-6>
              <div class="checkbox-input">
                <ion-checkbox name="useAddressInput" margin-right
                  [(ngModel)]="useAddressInput"
                  (click)="useAddressBook = false; useAddressInput = true; detectTimeout()"
                  (ionChange)="ref.detectChanges()"
                  (focusout)="ref.detectChanges()">
                </ion-checkbox>
                <ion-item>
                  <ion-label stacked>
                    {{ '_claims.subject.title-string' | translate }}*
                  </ion-label>
                  <ion-input name="subject" required
                    [(ngModel)]="subjectInput"
                    [disabled]="useAddressBook"
                    [placeholder]="'_claims.subject.desc' | translate"
                    (keydown)="submitOnEnter($event)"
                    (ionChange)="ref.detectChanges()"
                    (focusout)="ref.detectChanges()">
                  </ion-input>
                </ion-item>
              </div>
              <ion-chip class="error-hint" color="danger"
                *ngIf="">
                <ion-label>{{ '_claims.subject.error' | translate }}</ion-label>
              </ion-chip>
            </ion-col>
          </ion-row>

          <ng-container *ngIf="showClaimDisplayConfiguration">
            <ion-row>
              <ion-col col-12 col-md-6>
                <ion-item>
                  <ion-label stacked>{{ '_claims.mode.title' | translate }}*</ion-label>

                  <ion-select name="displayMode" interface="popover"
                    [(ngModel)]="displayMode"
                    [placeholder]="'_claims.mode.description' | translate"
                    (ionChange)="detectTimeout()"
                    (focusout)="detectTimeout()">
                    <ion-option value="icon">{{ '_claims.mode.icon' | translate }}</ion-option>
                    <ion-option value="normal">{{ '_claims.mode.normal' | translate }}</ion-option>
                    <ion-option value="detail">{{ '_claims.mode.detail' | translate }}</ion-option>
                  </ion-select>
                </ion-item>
              </ion-col>
              <ion-col col-12 col-md-6>
                <ion-item>
                  <ion-label>{{ '_claims.computed' | translate }}</ion-label>
                  <ion-toggle name="computedClaims"
                    [(ngModel)]="computedClaims"
                    (ionChange)="ref.detectChanges()">
                  </ion-toggle>
                </ion-item>
              </ion-col>
            </ion-row>
          </ng-container>

          <div text-center>
            <ion-chip class="error-hint" color="danger"
              *ngIf="(useAddressInput && selectForm?.controls?.subject?.touched && !isValidAddress(subjectInput)) || (useAddressBook && subjectSelectComp?.touched && subjectSelect.length === 0)">
              <ion-label>{{ '_claims.subject.error' | translate }}</ion-label>
            </ion-chip>
          </div>
        </form>

        <div text-right>
          <button ion-button outline round margin-top icon-left
            [disabled]="!isValidForm()"
            (click)="useCurrentValues()">
            {{ '_claims.use-topic' | translate }}
          </button>
        </div>
      </div>
      <div class="evan-content" *ngIf="showClaims">
        <h3 class="content-header m-b-0 m-t-0">
          {{ '_claims.claims' | translate }}
        </h3>
        <p ion-text class="m-b-0 m-t-0">
          {{ (addressbook[subject]?.alias || addressbook[subject]?.email) ? (addressbook[subject]?.alias || addressbook[subject]?.email) + ' (' + subject + ')' : subject }}
        </p>

        <div class="evan-relative" margin-top>
          <ng-container
            *ngTemplateOutlet="claimDisplay;context:{ topics: topics }">
          </ng-container>
        </div>
      </div>
      <div class="evan-content" *ngIf="showClaimDisplayConfiguration">
        <h3 class="content-header m-b-0 m-t-0">
          {{ '_claims.recreate-identity' | translate }}
        </h3>
        <p ion-text class="m-b-0 m-t-0">
          {{ '_claims.recreate-identity-description' | translate }}
        </p>
        <button ion-button outline round margin-top icon-left
          (click)="createIdentity()">
          {{ '_claims.recreate-identity' | translate }}
        </button>
      </div>
    </ng-container>
    
    <ng-container *ngIf="!showAddressSelect && !showTopicSelect">
      <ng-container
        *ngTemplateOutlet="claimDisplay;context:{ topics: topics }">
      </ng-container>
    </ng-container>
  </ng-container>
</ng-container>